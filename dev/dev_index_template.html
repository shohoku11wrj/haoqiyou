<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../haoqiyou.ico" type="image/x-icon">
    <link rel="shortcut icon" href="../haoqiyou.ico" type="image/x-icon">
    <title>好骑友网(骑行活动收集器)</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="dev_style.css">
    <!-- Make sure Leaflet's CSS before JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>  
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-51069014-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLaayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-51069014-1');
    </script>
    <script>
        let map; // Declare map variable outside the function

        function initMap() {
            if (!map) { // Check if map is already initialized
                const centerLocation = [37.53, -122.23];
                map = L.map('map-container').setView(centerLocation, 10);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
            }

            const events=[
                '{{map_content}}'
            ];
            
            events.map(event=>{
                var customIcon = null;
                if (event.event_time_type != "upcoming") {
                    customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `
                        <div style='background-color:transparent;'>
                            <img src="${event.icon_url}" style="width: 100%; height: 100%; background-color: transparent" />
                        </div>
                        `,
                        iconSize: [32, 32], // Size of the icon
                        iconAnchor: [16, 30], // Point of the icon which will correspond to marker's location
                        popupAnchor: [0, 0] // Point from which the popup should open relative to the iconAnchor
                    });
                } else {
                    customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `
                        <div style="position: relative; width: 32px; height: 32px; background-color: transparent">
                            <div style='background-color:transparent;'>
                                <img src="${event.icon_url}" style="width: 100%; height: 100%; background-color: transparent" />
                            </div>
                            <div class="tooltip-content" style="position: absolute; top: -50%; left: 50%; transform: translate(-50%, -50%); padding: 5px, 0px; border-radius: 5px; text-align: center; white-space: nowrap; font-size: 15px;">
                                ${event.date_span.month} <span style="color: #fc5200">${event.date_span.day}</span>
                            </div>
                        </div>
                        `,
                        iconSize: [32, 32], // Size of the icon
                        iconAnchor: [16, 32], // Point of the icon which will correspond to marker's location
                        popupAnchor: [0, 0] // Point from which the popup should open relative to the iconAnchor
                    });
                }
                var marker = L.marker([event.position.lat + event.shift[0], event.position.lng +  + event.shift[1]],
                                      { icon: customIcon }).addTo(map);
                marker.bindTooltip(event.title);  //.openTooltip(); // by default, the tooltip is open
                marker.on('click', function() {
                    const eventDetails = document.getElementById(event.id).innerHTML;
                    document.getElementById('popup-content').innerHTML = eventDetails;
                    document.getElementById('popup-overlay').style.display = 'block';
                    document.getElementById('popup').style.display = 'block';
                    // Update the URL
                    history.pushState(null, '', `?id=${event.id}`);
                });
                if (event.shift[0] != 0 || event.shift[1] != 0) {
                    // Add a red dot at the original position
                    var dot = L.circleMarker([event.position.lat, event.position.lng], {
                        radius: 5,
                        fillColor: "#ff0000",
                        color: "#ff0000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(map);

                    // Add a red line from the original position to the shifted position
                    var line = L.polyline([
                        [event.position.lat, event.position.lng],
                        [event.position.lat + event.shift[0], event.position.lng + event.shift[1]]
                    ], {
                        color: "#ff0000",
                        weight: 3,
                        opacity: 0.5
                    }).addTo(map);
                }
            });
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAa-YWC_WqDbvhOCOtfl1xmRo3CvRSeck&callback=initMap&libraries=places,geometry,marker&v=beta&loading=async"
    ></script>
</head>
<body>
    <div class="top-bar-container">
        <div class="column">
            <span class="top-bar"><a id="prod-link" href=".">好 骑 友</a></span>
            <script>
            document.addEventListener("DOMContentLoaded", function() {
                var link = document.getElementById("prod-link");
                var currentUrl = window.location.href;
                var newUrl = currentUrl.replace('/dev', '');
                link.href = newUrl;
            });
            </script>
        </div>
        <div class="column">
            <span>Updated on {{current_time_str_PDT}}</span><br/>
            <label>
                <input type="checkbox" id="toggleExtra">
                <span style="color:#0000ff">只显示精选活动</span>
            </label>
        </div>
    </div>

    <div class="page-container" id="page-container">
        <div class="list-container" id="list-container">
{{list_content}}
        </div>
        <div class="map-container" id="map-container">
            <!-- The map will be rendered here -->
        </div>
    </div>

    <div class="popup-overlay" id="popup-overlay"></div>
    <div class="popup" id="popup">
        <span class="close-btn" id="close-btn">&times;</span>
        <div id="popup-content"></div>
        <a href="#" id="load-commento-link">点击查看评论区</a>
        <div id="commento" style="display: none;"></div>
    </div>
<script src="../scripts.js"></script>
</body>
</html>