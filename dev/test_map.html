<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Maps Example</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>  
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
  <style>
    #map { height: 1080px; }
  </style>
  <script src="https://unpkg.com/leaflet-encoded@0.0.9/Polyline.encoded.js"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    function decodePolyline(str, precision) {
      var index = 0,
          lat = 0,
          lng = 0,
          coordinates = [],
          shift = 0,
          result = 0,
          byte = null,
          latitude_change,
          longitude_change,
          factor = Math.pow(10, precision || 5);

      while (index < str.length) {
        byte = null;
        shift = 0;
        result = 0;

        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);

        latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
        shift = result = 0;

        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);

        longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

        lat += latitude_change;
        lng += longitude_change;

        coordinates.push([lat / factor, lng / factor]);
      }

      return coordinates;
    }

    var map = L.map('map').setView([37.53, -122.23], 10);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    
    const events=[
        // {
        //     title: "SEP 01: ☝🏻",
        //     date_span: { month: "SEP", day: "01" },
        //     position: { lat: 33.68695, lng: -117.821 },
        //     shift: [0, 0],
        //     id: "event-66bce958be18d8701a365ca7",
        //     icon_url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        //     event_time_type: "upcoming"
        // },
        {
            title: "SEP 01: Sunday Paradise loop (beginner/intermediate)",
            date_span: { month: "SEP", day: "01" },
            position: { lat: 37.80598, lng: -122.452 },
            shift: [0, 0],
            id: "event-66ce71df133c2e5c9e25b494",
            icon_url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
            event_time_type: "upcoming",
            summary_polygon: 'sxwhF|`jiVTOb@YDNLXf@rARd@FNBNt@lBHPBHBFBFLXb@dAFRyDxBeFfC{@^q@Pg@HiAJeABq]?qGLmQ?sLBmFCuS?sB@q@B_ANs@V{@\\i@\\kAdAY^mDvFsAjBaA`Ak@`@}@d@aA\\MD_@Tn@xElBhSnAfMbA~J~@bIiAz@Lr@fAs@VlDj@lEZbE`ApJv@`JpBfSf@vEMJIHqBz@KDG?ECIBeBv@C?]PMHGLWH?@KDqBx@{Ax@}E~DqDrCmDvCuCbCiDtCuBjBoAjAcBjA{@|@QPOFCJMNfNr[nB~EhCbGvAhDzCzG@Vz@dBz@~BdAzBdCdGhC`GdAjCDHaKvJ{BlBoHfH_OhN}@bAUb@wP|O{HpHuKlMW`@Yj@mBdFy@hAkAbAyHhDk@b@eA`Am@x@e@x@y@dA_@^c@Za@VoE|AuFlD}@r@cHfHcMrLwAzA_@d@mCzE{AtDQZa@n@oAtC_CdDm@j@YReCdAwA`AYXo@z@kArBg@n@{AjA{AzAs@l@_C~A_@RoA^g@^uA~Aq@|@mDbE]Z{Az@WRu@|@UNUDs@?s@JUNs@jAWTYJu@HODWTWj@[rAkBjGWh@_A~Ae@fAQr@Ef@?`BAZGXEJKHu@JSHUP_A`A[RWJc@D_A@}@JwAd@qAl@sBp@U@c@A]Bk@Tc@ZoAnAWZoAxBoCzD_CfCsAbBKZCPBp@?j@K`@Q^w@pAa@f@YVqBrAaBnA_BbAcAf@YTq@~@aAjBi@|@ST[P_B|@]`@OVoA|CK^Cd@?~ADl@@j@Ef@SpAkAfF[t@]l@}CvEO^Mb@CT@d@Lh@Xv@F`@Bh@G~@K`@Od@]h@_AjAmBjBc@j@]l@SXSH}@LWL_@^Qd@cAzDYp@MR_@Xg@Zm@f@[Za@p@_AhC}AzDk@xC[|@Yb@s@t@o@j@oA|@m@h@mB`COZYjASdCI`@Wh@ONWF[@UB]JyB|A}BlBWL[DaAQM?QBe@XcAlAMRm@jBk@lAkDdE_AhB_@b@sBvAKLe@x@KX{@|Ci@vA_@b@gA|@]h@Qr@SlAM`@WXuA`A_@f@c@v@Md@AP?rCQnBOn@s@fBKPWX_Bt@yB|@e@VSTm@nAMZId@Ch@?|@Dl@?hAGbAI\\Qd@{ArBeBrCUl@U~B]z@uBdCe@b@q@b@sB`A_Al@k@j@gAxA]`@c@\\m@\\wA^u@\\a@VuAhAoBlB]x@o@xBYj@o@fA_@h@iAhA_ClBKJQb@M|@A^X|D@x@AXKZWf@a@d@q@d@}BjAuBxAiCfA}DnBUH}BZoDbAsBXUJWTSl@Ef@BZNp@`@jAH`@DtAAz@?VETGP[d@Q{A_@y@Kg@y@eAKU}@{CIk@Cc@AoDAaAKi@We@[YUG[Dq@Bc@AgCa@iCD[DaAf@MCKGKa@?sANeABc@Em@O_@IK]Yu@[a@IwAEi@GcCw@uAGSIm@k@c@IgAHwAf@UDU?SKQMsAcBw@m@_@Qc@Ki@GaABeCf@sDj@}@Xq@d@_CtBw@f@w@V}Bh@o@H]?UEe@WKIUYO]wAiEQ{@A[@e@Hs@Pg@pDkER[N]Fm@BeDBa@BaCIwBOyAs@uDEm@?kANgEAm@GYM_@iAkASWMa@EY?e@Fs@p@{BJi@Bw@C[EYQg@SYc@a@o@e@c@_@m@y@Q]M_@_@oBM_@_@g@WUe@UiC{@MGgBm@YK_@Qg@e@{IkLu@_AmBiCmPmTEEaFuGmDwEeAsAYa@mDuEQUs@p@kEzDg@d@}DlDmAbAgA~@KH}CdCuAlA{BpBgB|AqAjAgA`AaEpDuAlAuAlAgA~@WVqEzDaCpBwBjBOLmAbAsQrO_HfGmMhLcVtTaEpDgKpJkFrEsWpPiAv@oY|QkNjI_DlBwBrAcItEeF~CuAv@iBlAyAjA[Z{BlCoPxS_AhAGHkEpFsCpDy@fAmAtAeApAaAnAuGhI_@d@kAvAkDhEoBdCiAxAQTy@bAcBtB[b@S]U]Jc@yA}BW_@U]WZrCbET\\R\\GHcIzJkC|CaGpHgGfHa_@bd@WZCDeAnAMLq@v@UXiAvAwA`B_CpC_@b@_AfAkArACBED]`@YZIJORU^Yh@aAhBGJ[j@m@w@cAkAw@gA[e@aDcGE[A_@FsAEk@gNuP_FqGeI{J_@k@Wm@u@cBMm@O[QKQGoAGUAc@CPm@Jo@Z{BLw@b@yC`@kBxB_IjBiGhC{Jj@iBh@sAr@{AnA}Bh@kAr@yBpAiJR{@\\eAx@wBVs@R{@TeAzB{M~AgJ`@sAvCaJ^y@b@k@h@e@h@Y|DcAp@[f@_@d@m@^m@`@eAt@aCXu@r@iArD{E`D}Ef@}@\\w@V}@fAiFh@{Bx@yBtD_HxByDjEgHrB}CvBiC`AwAjAoBv@wAn@_BvA_EnH{UnFuPvA_EhEqKbAwBrAkDz@wCpAsGHe@c@K]S[]Wc@]uAc@aCKkA?{@VsDFgBl@oBz@cCRg@^u@ZyAL}AB}AIg@g@}E{@sEkAaIKy@ReEPgBRoA`E{Nl@oDj@mFj@yBzAeC|@sBfAaChGgKd@y@j@iAzBuFv@{BnGiS`@_BTyAf@{DBy@UsIDy@Na@j@[h@?~An@VARGHID]?g@EYMUiAoAo@kAOOQK_@EiAAuAk@c@]Ug@I_@MoBA{@@_@Dc@fBsKD_AA_@I[M]_BuCmAqBOo@Au@@Y^yAJs@@a@Ew@Mg@k@iBI_@Ca@HqAZ{AHi@Co@Gg@sAkFUo@U]UWsBcBW]Qk@Gg@Ck@Dk@dAoCDe@De@Ms@GQGOQKYMUGeCAgCi@o@K_@QSUK[g@gCM_@SUUQUMyF_AWKUQOSM_@{@yGMo@}B_JOg@M[MSQOUKeAMuBOo@Mn@LtBNdALTJPNLRLZNf@|B~ILn@z@xGL^NRTPVJxF~@TLTPRTL^f@fCJZRT^Pn@JfCh@dC@TFXLPJFNFPLr@Ed@Ed@eAnCEj@Bj@Ff@Pj@V\\rBbBTVT\\Tn@rAjFFf@Bn@Ih@[zAIpAB`@H^j@hBLf@Dv@A`@Kr@_@xAAX@t@Nn@lApB~AtCL\\HZ@^E~@gBrKEb@A^@z@LnBH^Tf@b@\\tAj@hA@^DPJNNn@jAhAnALTFh@Af@ELIHSFW@_Bo@i@?k@ZO`@Ex@TrICx@g@zDUxAa@~AoGhSw@zB{BtFk@hAe@x@iGfKgA`C}@rB{AdCk@xBk@lFm@nDaEzNSnAQfBSdEJx@jA`Iz@rEf@|EHf@C|AM|A[xA_@t@Sf@{@bCm@nBGfBWrD?z@JjAb@`C\\tAVb@Z\\\\Rb@Jd@iBj@aC\\oA\\aAb@_A`@o@b@i@l@i@z@i@hGwCh@e@d@a@d@o@lE}Gp@sA~N_]bGqNvAyCZi@rDkElHkIlJmKtC}ChDeDvLaLhAyA|IiOtNsP|FcIpJ_RbM{UzGiLl@w@|@_Az@m@nNcInBcAfBu@zFoBtFcBrAi@`Ag@nAy@~@u@nAwAlAaBpFmI~@cBvEyKfAqBpAgBj@k@~AiAdCcAdTgEpBm@pAc@|Au@dBaAhLsHhHkEdT_MtBgBz@eAh@y@jCeFz@wArBsCpBwB~CkCRQrCsCvKwL|@_A`Au@|@g@hA[hASr@Gt@AxNNlCCpAI`I{@lHq@`AOv@Sz@[z@_@nE{BvUiMx@e@tB}AlJuI~BgB`CyA`DaBdAa@fAa@pQuFlCmAjBoAfKcJdy@sp@tV_S~r@ek@tAcA~AeAfCuAd@WFEZQ@?p@i@t@i@XYdByA`CwBr@u@r@q@jL}L\\_@BEnLuM`KuLzNuPlDiElTeWt@q@hA}@dAq@v@a@lAe@vCs@~ZiEhAYbA_@|@c@~@m@z@u@~FwFx@o@t@e@bAc@hA[bBYtQeBzK{@vQcBlBKpIOpCO|AYfBa@rAm@fB}@xKoGnAc@nAa@jAQhMcB~A]zAi@nF}BlEuBb@MdAOB?rAGCcAEy@G}@K{@M}@Qw@S{@U{@Si@jBg@?@kBd@h@dBd@rBXxBLvBBbANxNVp_@d@e@vBy@JIRg@HOVOn@G~A_@zAS`GkBpBu@T@f@VPBXA~@MPGf@_@p@w@NMxAq@\\Uj@}@\\s@Vo@f@aCTu@z@gCf@qA\\m@x@gAj@q@VSj@_@pBy@PAf@@r@Jd@LlIfEv@P^@vAMt@Sf@YZ_@Xy@HOJGl@Mj@?^NLNZd@VXZTp@Lg@iG?m@Fe@HQPI`@EfNtDpAHxRn@XERIr@i@PSFGTINELAJ?NBRDTFJLFPRpABNBRPxALb@h@bBBFBFLZhAnCDJDJc@L]JrA~C'
        },
        // {
        //     title: "SEP 03: Mike's Bikes Shop Ride",
        //     date_span: { month: "SEP", day: "03" },
        //     position: { lat: 37.22634, lng: -121.98254 },
        //     shift: [0.03, 0],
        //     id: "event-66a5cbd49719a87a0cc4301e",
        //     icon_url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        //     event_time_type: "upcoming"
        // },
        // {
        //     title: "SEP 02: Bonus Group Road Ride - 9, Skyline, OLH, Alpine",
        //     date_span: { month: "SEP", day: "02" },
        //     position: { lat: 37.22641, lng: -121.98229 },
        //     shift: [0, 0.03],
        //     id: "event-66cfc2f81c7c4054e1c36654",
        //     icon_url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        //     event_time_type: "upcoming"
        // },
        {
            title: "SEP 01: Group Road Ride - South IBM",
            date_span: { month: "SEP", day: "01" },
            position: { lat: 37.2262, lng: -121.98224 },
            shift: [-0.03, 0],
            id: "event-66ce71df133c2e5c9e25b492",
            icon_url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
            event_time_type: "upcoming"
        },
  ];
  
  events.map(event=>{
    var customIcon = L.divIcon({
      html: `
        <div style="position: relative; width: 32px; height: 32px; background-color: transparent">
          <img src="http://maps.google.com/mapfiles/ms/icons/green-dot.png" style="width: 100%; height: 100%; background-color: transparent" />
          <div style="position: absolute; top: -50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 5px; border-radius: 5px; text-align: center; white-space: nowrap;">
            ${event.date_span.month} <span style="color: #fc5200">${event.date_span.day}</span>
          </div>
        </div>
      `,
      iconSize: [32, 32], // Size of the icon
      iconAnchor: [0, 0], // Point of the icon which will correspond to marker's location
      popupAnchor: [0, 0] // Point from which the popup should open relative to the iconAnchor
    });
    var marker = L.marker([event.position.lat, event.position.lng], { icon: customIcon }).addTo(map);
    // const iconElement = document.createElement('div');
    // iconElement.innerHTML = `
    //     <div style="position: absolute; top: -50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 5px; border-radius: 5px; text-align: center; white-space: nowrap;">
    //       ${event.date_span.month} <span style="color: #fc5200">${event.date_span.day}</span>
    //     </div>
    // `;
    // marker.bindTooltip(iconElement).openTooltip();
    // marker.bindPopup(iconElement).openPopup();
    if (event.summary_polygon) {
      var decodedPath = decodePolyline(event.summary_polygon);
      var routeLine = L.polyline(decodedPath, {
          color: '#007bf6',
          weight: 4,
          opacity: 1.0
      }).addTo(map);

      // Fit the map to the route bounds
      map.fitBounds(routeLine.getBounds());
    }
  });
  </script>
</body>
</html>